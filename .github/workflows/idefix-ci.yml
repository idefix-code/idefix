name: Idefix CIs
on:
  workflow_dispatch:
  push:
    branches:
      - master
  pull_request:

concurrency:
  # auto-cancel any concurrent job *in the same context*
  # see https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#concurrency
  # see https://docs.github.com/en/actions/learn-github-actions/contexts#github-context
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TESTME_OPTIONS: -cuda -Werror
  PYTHONPATH: ${{ github.workspace }}
  IDEFIX_DIR: ${{ github.workspace }}

jobs:
  Linter:
    # Don't do this in forks
    if: github.repository == 'idefix-code/idefix'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          lfs: false
      - uses: actions/setup-python@v4
        with:
          python-version: 3.x
      - uses: pre-commit/action@v3.0.0
      - uses: pre-commit-ci/lite-action@v1.0.0
        if: always()

  ShocksHydro:
    needs: Linter
    runs-on: self-hosted
    steps:
      - name: Check out repo
        uses: actions/checkout@v3
        with:
          lfs: true
          submodules: recursive
      # Manually do a git LFS https://github.com/actions/checkout/issues/270
      - run: git lfs pull
      - name: Sod test
        run: |
          cd $IDEFIX_DIR/test/HD/sod
          ./testme.py -all $TESTME_OPTIONS
      - name: Isothermal Sod test
        run: |
          cd $IDEFIX_DIR/test/HD/sod-iso
          ./testme.py -all $TESTME_OPTIONS
      - name: Mach reflection test
        run: |
          cd $IDEFIX_DIR/test/HD//MachReflection
          ./testme.py -all $TESTME_OPTIONS

  Examples:
    needs: [ShocksHydro]
    runs-on: self-hosted
    steps:
      - name: Check out repo
        uses: actions/checkout@v3
        with:
          lfs: true
          submodules: recursive
      # Manually do a git LFS https://github.com/actions/checkout/issues/270
      - run: git lfs pull
      - name: Run examples test
        run: cd test && ./checks_examples.sh $TEST_OPTIONS

  Utils:
    needs: [ShocksHydro]
    runs-on: self-hosted
    steps:
      - name: Check out repo
        uses: actions/checkout@v3
        with:
          lfs: true
          submodules: recursive
      # Manually do a git LFS https://github.com/actions/checkout/issues/270
      - run: git lfs pull
      - name: Run utils test
        run: cd test && ./checks_utils.sh $TEST_OPTIONS
